{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% block extrastyle %}
<link rel="stylesheet" type="text/css" href="{% static "css/status.css" %}" />
<link rel="stylesheet" type="text/css" href="{% static "css/custom-icons.css" %}" />
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
{% endblock %}

{% block title %}Tableau de bord{% endblock %}

{% block content %}
<div class="status" id="status">
    <div class="sensor-background">
        <div class="sensor-data">
            <img class="sensor-logo" src="{% static "images/temperature.png" %}" alt="temperature"/>
            {% for sensor in temperature %}
            <div class="frame-spacer">
                <div class="frame" id="frame-{{ sensor.name }}-temp">
                    <div class="gauge" id="gauge-{{ sensor.name }}-temp"></div>
                    <div class="ilya">{{ sensor.since_when }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="sensor-spacer"></div>

    <div class="sensor-background">
        <div class="sensor-data">
            <img class="sensor-logo" src="{% static "images/humidity.png" %}" alt="humidite"/>
            {% for sensor in humidity %}
            <div class="frame-spacer">
                <div class="frame" id="frame-{{ sensor.name }}-humidity">
                    <div class="gauge" id="gauge-{{ sensor.name }}-humidity"></div>
                    <div class="ilya">{{ sensor.since_when }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="sensor-spacer"></div>

    <div class="sensor-background">
        <div class="sensor-data">
            <img class="sensor-logo" src="{% static "images/power.png" %}" alt="puissance"/>
            <div class="frame-spacer">
                <div class="frame" id="frame-{{ power.name }}">
                    <div class="gauge" id="gauge-{{ power.name }}"></div>
                    <div class="ilya">{{ power.since_when }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="buttons" id="buttons">
    <div class="button" id="graphs">&nbsp;</div>
    <div class="button" id="schedule">&nbsp;</div>
    <div class="button" id="refresh">&nbsp;</div>
</div>
{% endblock %}

{% block script %}
    $('#graphs').button({
        icons: {
            primary: "custom-icon-graphs"
        },
        text: false
    }).click(function() {
        window.location.href="/graph/all/temp";
    });
    $('#schedule').button({
        icons: {
            primary: "custom-icon-schedule"
        },
        text: false
    }).click(function() {
        window.location.href="/program";
    });
    $('#refresh').button({
        icons: {
            primary: "custom-icon-refresh"
        },
        text: false
    }).click(function() {
        window.location.reload();
    });
    {% for sensor in temperature %}
        $('#frame-{{ sensor.name }}-temp').click(function() {
            window.location.href="/graph/{{ sensor.name|lower }}/temp";
        });
    {% endfor %}
    $('#frame-{{ power.name }}').click(function() {
        window.location.href="/graph/{{ power.name|lower }}/power";
    });

    center_elements = function() {
        $('#buttons').position({
            my: "center top",
            at: "center bottom",
            of: "#content"
        });
        $('#status').position({
            my: "center",
            at: "center",
            of: "#content"
        });
    }

    google.load("visualization", "1.0", {packages:["gauge"]});
    google.setOnLoadCallback(drawChart);

    function drawChart() {

        // Options common to all temperature gauges
        var temp_options = {
            animation: { startup: true,
                         duration: 1000,
                         easing: 'out'},
            width: 150, height: 150,
            min: -20, max: 40,
            greenFrom: -20, greenTo: 0, greenColor: '#aaaaff',
            yellowFrom: 27, yellowTo: 40, yellowColor: '#ffe773',
            minorTicks: 5
        };

        var temp_formatter = new google.visualization.NumberFormat(
            { suffix: '\u00B0C', pattern: '#.#' }
        );

        // Options common to all temperature gauges
        var humidity_options = {
            animation: { startup: true,
                         duration: 1000,
                         easing: 'out'},
            width: 150, height: 150,
            min: 0, max: 100,
            greenFrom: 0, greenTo: 30, greenColor: '#ffe773',
            yellowFrom: 70, yellowTo: 100, yellowColor: '#aaaaff',
            minorTicks: 5
        };

        var humidity_formatter = new google.visualization.NumberFormat(
            { suffix: '%', pattern: '#' }
        );

        // Options for power gauge
        var power_options = {
            animation: { startup: true,
                         duration: 1000,
                         easing: 'out'},
            width: 150, height: 150,
            min: 0, max: 4000,
            greenFrom: 0, greenTo: 500, greenColor: '#aaaaff',
            yellowFrom: 1500, yellowTo: 3000, yellowColor: '#ffe773',
            redFrom: 3000, redTo: 4000, redColor: '#ff6445',
            minorTicks: 5
        };

        var power_formatter = new google.visualization.NumberFormat(
            { suffix: 'kW', pattern: '#.##' }
        );

        // Temperature gauges
        {% for sensor in temperature %}
            var data_{{ sensor.name }}_temp = google.visualization.arrayToDataTable([
                ['Label', 'Value'],
                ['{{ sensor.name }}', -20],
            ]);

            var chart_{{ sensor.name }}_temp = new google.visualization.Gauge(document.getElementById('gauge-{{ sensor.name }}-temp'));
            chart_{{ sensor.name }}_temp.draw(data_{{ sensor.name }}_temp, temp_options);
        {% endfor %}

        // Humidity gauges
        {% for sensor in humidity %}
            var data_{{ sensor.name }}_humidity = google.visualization.arrayToDataTable([
                ['Label', 'Value'],
                ['{{ sensor.name }}', 0],
            ]);

            var chart_{{ sensor.name }}_humidity = new google.visualization.Gauge(document.getElementById('gauge-{{ sensor.name }}-humidity'));
            chart_{{ sensor.name }}_humidity.draw(data_{{ sensor.name }}_humidity, humidity_options);
        {% endfor %}

        // Power gauge
        var data_{{ power.name }} = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['{{ power.name }}', 0],
        ]);

        var chart_{{ power.name }} = new google.visualization.Gauge(document.getElementById('gauge-{{ power.name }}'));
        chart_{{ power.name }}.draw(data_{{ power.name }}, power_options);

        setTimeout(function() {
            {% for sensor in temperature %}
                var data_{{ sensor.name }}_temp = google.visualization.arrayToDataTable([
                    ['Label', 'Value'],
                    ['{{ sensor.name }}', {{ sensor.temp }}],
                ]);
                temp_formatter.format(data_{{ sensor.name }}_temp, 1);
                chart_{{ sensor.name }}_temp.draw(data_{{ sensor.name }}_temp, temp_options);
            {% endfor %}

            {% for sensor in humidity %}
                var data_{{ sensor.name }}_humidity = google.visualization.arrayToDataTable([
                    ['Label', 'Value'],
                    ['{{ sensor.name }}', {{ sensor.humidity }}],
                ]);
                humidity_formatter.format(data_{{ sensor.name }}_humidity, 1);
                chart_{{ sensor.name }}_humidity.draw(data_{{ sensor.name }}_humidity, humidity_options);
            {% endfor %}

            var data_{{ power.name }} = google.visualization.arrayToDataTable([
                ['Label', 'Value'],
                ['{{ power.name }}', {{ power.power }}],
            ]);
            power_formatter.format(data_{{ power.name }}, 1);
            chart_{{ power.name }}.draw(data_{{ power.name }}, power_options);
        }, 200);
    }

    center_elements();
    $(window).resize(function() {
        center_elements();
    });
{% endblock %}

