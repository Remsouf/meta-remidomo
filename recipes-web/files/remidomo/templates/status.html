{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% block extrastyle %}
<link rel="stylesheet" type="text/css" href="{% static "css/status.css" %}" />
<link rel="stylesheet" type="text/css" href="{% static "css/custom-icons.css" %}" />
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
{% endblock %}

{% block title %}Tableau de bord{% endblock %}

{% block content %}
<div class="status" id="status">
    {% for sensor in temperature %}
    <div class="frame-spacer">
        <div class="frame" id="frame-{{ sensor.name }}">
            <div class="gauge" id="gauge-{{ sensor.name }}"></div>
            <div class="ilya">{{ sensor.since_when }}</div>
        </div>
    </div>
    {% endfor %}
    <div class="frame-spacer">
        <div class="frame" id="frame-{{ power.name }}">
            <div class="gauge" id="gauge-{{ power.name }}"></div>
            <div class="ilya">{{ power.since_when }}</div>
        </div>
    </div>
</div>

<div class="buttons" id="buttons">
    <div class="button" id="graphs">&nbsp;</div>
    <div class="button" id="schedule">&nbsp;</div>
    <div class="button" id="refresh">&nbsp;</div>
</div>
{% endblock %}

{% block script %}
    $('#graphs').button({
        icons: {
            primary: "custom-icon-graphs"
        },
        text: false
    }).click(function() {
        window.location.href="/graph/all/temp";
    });
    $('#schedule').button({
        icons: {
            primary: "custom-icon-schedule"
        },
        text: false
    }).click(function() {
        window.location.href="/program";
    });
    $('#refresh').button({
        icons: {
            primary: "custom-icon-refresh"
        },
        text: false
    }).click(function() {
        window.location.reload();
    });
    {% for sensor in temperature %}
        $('#frame-{{ sensor.name }}').click(function() {
            window.location.href="/graph/{{ sensor.name|lower }}/temp";
        });
    {% endfor %}
    $('#frame-{{ power.name }}').click(function() {
        window.location.href="/graph/{{ power.name|lower }}/power";
    });

    center_elements = function() {
        $('#buttons').position({
            my: "center top",
            at: "center bottom",
            of: "#content"
        });
        $('#status').position({
            my: "center",
            at: "center",
            of: "#content"
        });
    }

    google.load("visualization", "1.0", {packages:["gauge"]});
    google.setOnLoadCallback(drawChart);

    function drawChart() {

        // Options common to all temperature gauges
        var temp_options = {
            animation: { startup: true,
                         duration: 1000,
                         easing: 'out'},
            width: 200, height: 200,
            min: -20, max: 40,
            greenFrom: -20, greenTo: 0, greenColor: '#aaaaff',
            yellowFrom: 27, yellowTo: 40, yellowColor: '#ffe773',
            minorTicks: 5
        };

        // Options for power gauge
        var power_options = {
            animation: { startup: true,
                         duration: 1000,
                         easing: 'out'},
            width: 200, height: 200,
            min: 0, max: 4000,
            greenFrom: 0, greenTo: 500, greenColor: '#aaaaff',
            yellowFrom: 1500, yellowTo: 3000, yellowColor: '#ffe773',
            redFrom: 3000, redTo: 4000, redColor: '#ff6445',
            minorTicks: 5
        };

        // Temperature gauges
        {% for sensor in temperature %}
            var data_{{ sensor.name }} = google.visualization.arrayToDataTable([
                ['Label', 'Value'],
                ['{{ sensor.name }}', -20],
            ]);

            var chart_{{ sensor.name }} = new google.visualization.Gauge(document.getElementById('gauge-{{ sensor.name }}'));
            chart_{{ sensor.name }}.draw(data_{{ sensor.name }}, temp_options);
        {% endfor %}

        // Power gauge
        var data_{{ power.name }} = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['{{ power.name }}', 0],
        ]);

        var chart_{{ power.name }} = new google.visualization.Gauge(document.getElementById('gauge-{{ power.name }}'));
        chart_{{ power.name }}.draw(data_{{ power.name }}, power_options);

        setTimeout(function() {
            {% for sensor in temperature %}
                var data_{{ sensor.name }} = google.visualization.arrayToDataTable([
                    ['Label', 'Value'],
                    ['{{ sensor.name }}', {{ sensor.temp }}],
                ]);
                chart_{{ sensor.name }}.draw(data_{{ sensor.name }}, temp_options);
            {% endfor %}

            var data_{{ power.name }} = google.visualization.arrayToDataTable([
                ['Label', 'Value'],
                ['{{ power.name }}', {{ power.power }}],
            ]);
            chart_{{ power.name }}.draw(data_{{ power.name }}, power_options);
        }, 200);
    }

    center_elements();
    $(window).resize(function() {
        center_elements();
    });
{% endblock %}

